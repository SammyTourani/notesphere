<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåç World-Class Multi-Engine Grammar System Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2d3748;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .test-section {
            margin: 30px 0;
            padding: 25px;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            background: #f8fafc;
        }
        .test-section h2 {
            color: #4a5568;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 14px;
            line-height: 1.5;
        }
        .success { 
            background: #f0fff4; 
            border: 2px solid #68d391; 
            color: #22543d;
        }
        .error { 
            background: #fed7d7; 
            border: 2px solid #fc8181; 
            color: #742a2a;
        }
        .warning { 
            background: #fefcbf; 
            border: 2px solid #f6e05e; 
            color: #744210;
        }
        .info {
            background: #ebf8ff;
            border: 2px solid #63b3ed;
            color: #2a4365;
        }
        textarea {
            width: 100%;
            height: 120px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 16px;
            resize: vertical;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .issue-item {
            background: white;
            margin: 8px 0;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .issue-header {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }
        .issue-details {
            font-size: 12px;
            color: #718096;
        }
        .engine-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            margin-left: 8px;
        }
        .performance-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        .fast { background: #c6f6d5; color: #22543d; }
        .medium { background: #fefcbf; color: #744210; }
        .slow { background: #fed7d7; color: #742a2a; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåç Phase 2: Multi-Engine Grammar Service</h1>
        <p style="text-align: center; color: #718096; font-size: 18px; margin-bottom: 40px;">
            Production-hardened grammar checking with concurrent processing, caching, and failover
        </p>

        <!-- Engine Status Test -->
        <div class="test-section">
            <h2>üöÄ Engine Status & Initialization</h2>
            <p>Test if all grammar engines are properly initialized and ready</p>
            <button onclick="testEngineStatus()">Check Engine Status</button>
            <div id="engineStatus" class="result" style="display: none;"></div>
        </div>

        <!-- Quick Performance Test -->
        <div class="test-section">
            <h2>‚ö° Performance Test</h2>
            <p>Test processing speed with complex text (Target: &lt;800ms)</p>
            <button onclick="testPerformance()">Run Performance Test</button>
            <div id="performanceResults" class="result" style="display: none;"></div>
        </div>

        <!-- Comprehensive Analysis Test -->
        <div class="test-section">
            <h2>üéØ Comprehensive Error Detection</h2>
            <p>Test error detection across all categories (Target: 15-25 errors)</p>
            <button onclick="testComprehensiveAnalysis()">Analyze Complex Text</button>
            <div id="comprehensiveResults" class="result" style="display: none;"></div>
        </div>

        <!-- Custom Text Analysis -->
        <div class="test-section">
            <h2>‚úçÔ∏è Custom Text Analysis</h2>
            <p>Test your own text with the multi-engine system</p>
            <textarea id="customText" placeholder="Type or paste your text here to analyze with all engines...">Between you and I, each of the students have finished there homework incorrectly. The data clearly shows that none of the participants was prepared for they're final exam. I could of helped them, but their going to have to learn this themself. Me and my colleague thinks that this are a serious problem that effects everyone. Due to the fact that we need to think outside the box, we should seperate the students who performed alot better then the others.</textarea>
            <button onclick="testCustomText()">Analyze Custom Text</button>
            <div id="customResults" class="result" style="display: none;"></div>
        </div>

        <!-- Deduplication Test -->
        <div class="test-section">
            <h2>üîç Smart Deduplication Test</h2>
            <p>Test how well the system removes duplicate errors from multiple engines</p>
            <button onclick="testDeduplication()">Test Deduplication</button>
            <div id="deduplicationResults" class="result" style="display: none;"></div>
        </div>

        <!-- System Statistics -->
        <div class="test-section">
            <h2>üìä System Statistics</h2>
            <p>View comprehensive statistics from all engines</p>
            <button onclick="viewStatistics()">View Statistics</button>
            <div id="statisticsResults" class="result" style="display: none;"></div>
        </div>
    </div>

    <script type="module">
        let multiEngineService = null;

        // Initialize the Multi-Engine Grammar Service
        async function initializeService() {
            try {
                console.log('üåç Test Page: Starting Multi-Engine Grammar Service initialization...');
                const { default: MultiEngineGrammarService } = await import('./src/services/MultiEngineGrammarService.ts');
                
                console.log('üîß Test Page: Creating service instance...');
                multiEngineService = new MultiEngineGrammarService({
                    maxConcurrentRequests: 5,
                    targetProcessingTime: 200,
                    enableDeduplication: true,
                    enableCaching: true,
                    enableFailover: true
                });
                
                // Wait for initialization - the service handles its own async initialization
                console.log('‚è≥ Test Page: Waiting for service initialization...');
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // Verify the service is ready
                if (!multiEngineService) {
                    throw new Error('Service instance is null after initialization');
                }
                
                console.log('‚úÖ Test Page: Multi-Engine Grammar Service initialized successfully');
                return true;
            } catch (error) {
                console.error('‚ùå Test Page: Failed to initialize Multi-Engine Grammar Service:', error);
                multiEngineService = null;
                return false;
            }
        }

        // Test engine status and initialization
        window.testEngineStatus = async function() {
            const container = document.getElementById('engineStatus');
            container.style.display = 'block';
            container.innerHTML = '<div>üîÑ Checking engine status...</div>';
            
            try {
                // Ensure service is initialized and ready
                if (!multiEngineService) {
                    console.log('üîß Test: Service not initialized, initializing now...');
                    const initialized = await initializeService();
                    if (!initialized) {
                        throw new Error('Failed to initialize Multi-Engine Grammar Service');
                    }
                }
                
                // Double-check service is ready
                if (!multiEngineService) {
                    throw new Error('Service instance is null after initialization');
                }
                
                // Get actual engine status from Multi-Engine Service
                const stats = multiEngineService.getStatistics();
                
                let statusHTML = '<div class="success">‚úÖ Multi-Engine Grammar Service Status</div>\n\n';
                statusHTML += `<div class="stats-grid">`;
                
                statusHTML += `<div class="stat-card">
                    <div class="stat-value">${stats.global.totalRequests}</div>
                    <div class="stat-label">Total Requests</div>
                </div>`;
                
                statusHTML += `<div class="stat-card">
                    <div class="stat-value">${Math.round(stats.global.successRate)}%</div>
                    <div class="stat-label">Success Rate</div>
                </div>`;
                
                statusHTML += `<div class="stat-card">
                    <div class="stat-value">${Math.round(stats.global.averageProcessingTime)}ms</div>
                    <div class="stat-label">Avg Processing Time</div>
                </div>`;
                
                statusHTML += `<div class="stat-card">
                    <div class="stat-value">${stats.health.systemHealth}</div>
                    <div class="stat-label">System Health</div>
                </div>`;
                
                statusHTML += `</div>\n\n`;
                statusHTML += '<strong>üîß Service Details:</strong>\n';
                statusHTML += `\nüìä <strong>Performance:</strong>`;
                statusHTML += `\n   ‚Ä¢ Target Time: ${stats.performance.targetTime}ms`;
                statusHTML += `\n   ‚Ä¢ Current Average: ${Math.round(stats.performance.currentAverage)}ms`;
                statusHTML += `\n   ‚Ä¢ Efficiency: ${Math.round(stats.performance.efficiency)}%`;
                statusHTML += `\n   ‚Ä¢ Active Requests: ${stats.global.activeRequests}`;
                statusHTML += `\n   ‚Ä¢ Queued Requests: ${stats.global.queuedRequests}`;
                statusHTML += `\n   ‚Ä¢ Cache Hit Rate: ${stats.global.cacheHitRate}%`;
                
                statusHTML += `\n\nüîß <strong>Engine Status:</strong>\n`;
                for (const engine of stats.engines) {
                    const isLoaded = engine.status === 'loaded' ? '‚úÖ' : '‚ùå';
                    const performance = engine.health.averageProcessingTime < 100 ? 'fast' : 
                                       engine.health.averageProcessingTime < 300 ? 'medium' : 'slow';
                    
                    statusHTML += `\n${isLoaded} <strong>${engine.name}</strong>`;
                    statusHTML += `<span class="performance-indicator ${performance}">${Math.round(engine.health.averageProcessingTime || 0)}ms</span>`;
                    statusHTML += `\n   ‚îî‚îÄ Status: ${engine.status}`;
                    statusHTML += `\n   ‚îî‚îÄ Health: ${engine.health.overallHealth} (${engine.health.successCount}‚úì, ${engine.health.errorCount}‚úó)`;
                    if (engine.health.lastUsed) {
                        statusHTML += `\n   ‚îî‚îÄ Last Used: ${new Date(engine.health.lastUsed).toLocaleTimeString()}`;
                    }
                }
                
                container.innerHTML = statusHTML;
                container.className = 'result success';
                
            } catch (error) {
                container.innerHTML = `‚ùå Engine status check failed: ${error.message}`;
                container.className = 'result error';
            }
        };

        // Test performance with complex text
        window.testPerformance = async function() {
            const container = document.getElementById('performanceResults');
            container.style.display = 'block';
            container.innerHTML = '<div>‚ö° Running performance test...</div>';
            
            try {
                // Ensure service is initialized and ready
                if (!multiEngineService) {
                    console.log('üîß Test: Service not initialized, initializing now...');
                    const initialized = await initializeService();
                    if (!initialized) {
                        throw new Error('Failed to initialize Multi-Engine Grammar Service');
                    }
                }
                
                // Double-check service is ready
                if (!multiEngineService) {
                    throw new Error('Service instance is null after initialization');
                }
                
                const complexText = `Between you and I, each of the students have finished there homework incorrectly. The data clearly shows that none of the participants was prepared for they're final exam. I could of helped them, but their going to have to learn this themself. Me and my colleague thinks that this are a serious problem that effects everyone. Due to the fact that we need to think outside the box, we should seperate the students who performed alot better then the others. In order to achieve better results, we need to accomodate there needs more effectively. This is a neccessary step that will definitly help improve the situation. The occassion calls for immediate action, and we should not embarass ourselves by failing to act. It's wierd how such a simple freind can make such a difference in our lives.`;
                
                const startTime = Date.now();
                const result = await multiEngineService.checkText(complexText);
                const totalTime = Date.now() - startTime;
                
                const performanceRating = totalTime < 200 ? 'Excellent ‚ö°' : 
                                        totalTime < 400 ? 'Good üëç' : 
                                        'Needs Optimization ‚ö†Ô∏è';
                
                const performanceClass = totalTime < 200 ? 'success' : 
                                       totalTime < 400 ? 'warning' : 'error';
                
                let resultHTML = `<strong>‚ö° Performance Test Results</strong>\n\n`;
                resultHTML += `<div class="stats-grid">`;
                resultHTML += `<div class="stat-card">
                    <div class="stat-value">${totalTime}ms</div>
                    <div class="stat-label">Total Processing Time</div>
                </div>`;
                resultHTML += `<div class="stat-card">
                    <div class="stat-value">${result.issues.length}</div>
                    <div class="stat-label">Errors Detected</div>
                </div>`;
                resultHTML += `<div class="stat-card">
                    <div class="stat-value">${result.statistics?.enginesUsed || 'N/A'}</div>
                    <div class="stat-label">Engines Used</div>
                </div>`;
                resultHTML += `<div class="stat-card">
                    <div class="stat-value">${performanceRating}</div>
                    <div class="stat-label">Performance Rating</div>
                </div>`;
                resultHTML += `</div>\n\n`;
                
                if (result.statistics?.engineContributions) {
                    resultHTML += `üìä <strong>Engine Performance:</strong>\n`;
                    for (const [engine, issues] of Object.entries(result.statistics.engineContributions)) {
                        resultHTML += `   ‚Ä¢ ${engine}: ${issues} issues\n`;
                    }
                }
                
                resultHTML += `\n\nüéØ <strong>Target:</strong> <200ms (Current: ${totalTime}ms)`;
                resultHTML += `\n‚úÖ <strong>Status:</strong> ${performanceRating}`;
                
                container.innerHTML = resultHTML;
                container.className = `result ${performanceClass}`;
                
            } catch (error) {
                container.innerHTML = `‚ùå Performance test failed: ${error.message}`;
                container.className = 'result error';
            }
        };

        // Test comprehensive error detection
        window.testComprehensiveAnalysis = async function() {
            const container = document.getElementById('comprehensiveResults');
            container.style.display = 'block';
            container.innerHTML = '<div>üéØ Running comprehensive analysis...</div>';
            
            try {
                // Ensure service is initialized and ready
                if (!multiEngineService) {
                    console.log('üîß Test: Service not initialized, initializing now...');
                    const initialized = await initializeService();
                    if (!initialized) {
                        throw new Error('Failed to initialize Multi-Engine Grammar Service');
                    }
                }
                
                // Double-check service is ready
                if (!multiEngineService) {
                    throw new Error('Service instance is null after initialization');
                }
                
                const challengingText = `Between you and I, each of the students have finished there homework incorrectly. The data clearly shows that none of the participants was prepared for they're final exam. I could of helped them, but their going to have to learn this themself. Me and my colleague thinks that this are a serious problem that effects everyone. Due to the fact that we need to think outside the box, we should seperate the students who performed alot better then the others. In order to achieve better results, we need to accomodate there needs more effectively. This is a neccessary step that will definitly help improve the situation. The occassion calls for immediate action, and we should not embarass ourselves by failing to act. It's wierd how such a simple freind can make such a difference in our lives. Your going to need to loose some weight if you want to be more healthy. Its important to recieve feedback from others who care about you.`;
                
                const result = await multiEngineService.checkText(challengingText);
                
                const qualityRating = result.issues.length >= 20 ? 'Professional Grade üèÜ' :
                                    result.issues.length >= 15 ? 'Advanced üéØ' :
                                    result.issues.length >= 10 ? 'Good üëç' :
                                    'Basic ‚ö†Ô∏è';
                
                const qualityClass = result.issues.length >= 15 ? 'success' : 
                                   result.issues.length >= 10 ? 'warning' : 'error';
                
                let resultHTML = `<strong>üéØ Comprehensive Analysis Results</strong>\n\n`;
                resultHTML += `<div class="stats-grid">`;
                resultHTML += `<div class="stat-card">
                    <div class="stat-value">${result.issues.length}</div>
                    <div class="stat-label">Total Errors Found</div>
                </div>`;
                resultHTML += `<div class="stat-card">
                    <div class="stat-value">${result.statistics?.qualityScore || 'N/A'}</div>
                    <div class="stat-label">Quality Score</div>
                </div>`;
                resultHTML += `<div class="stat-card">
                    <div class="stat-value">${result.statistics?.processingTime || 'N/A'}ms</div>
                    <div class="stat-label">Processing Time</div>
                </div>`;
                resultHTML += `<div class="stat-card">
                    <div class="stat-value">${qualityRating}</div>
                    <div class="stat-label">Detection Level</div>
                </div>`;
                resultHTML += `</div>\n\n`;
                
                // Engine contributions with latencies
                if (result.statistics?.engineContributions) {
                    resultHTML += `üöÄ <strong>Engine Contributions:</strong>\n`;
                    for (const [engine, issues] of Object.entries(result.statistics.engineContributions)) {
                        const latency = result.statistics.engineLatencies?.[engine] || 'N/A';
                        const performance = typeof latency === 'number' ? 
                            (latency < 100 ? '‚ö°' : latency < 300 ? 'üëç' : '‚ö†Ô∏è') : '';
                        resultHTML += `   ‚Ä¢ ${engine}: ${issues} issues (${latency}ms) ${performance}\n`;
                    }
                }
                
                // Sample issues
                resultHTML += `\nüîç <strong>Sample Issues Found:</strong>\n`;
                result.issues.slice(0, 5).forEach((issue, index) => {
                    resultHTML += `\n${index + 1}. <strong>${issue.message}</strong>`;
                    resultHTML += `<span class="engine-badge">${issue.engine || 'unknown'}</span>`;
                    resultHTML += `\n   Category: ${issue.category || 'unknown'} | Confidence: ${Math.round((issue.confidence || 0) * 100)}%`;
                    if (issue.suggestions && issue.suggestions.length > 0) {
                        resultHTML += `\n   Suggestions: ${issue.suggestions.slice(0, 2).join(', ')}`;
                    }
                    resultHTML += `\n`;
                });
                
                if (result.issues.length > 5) {
                    resultHTML += `\n... and ${result.issues.length - 5} more issues`;
                }
                
                resultHTML += `\n\nüéØ <strong>Target:</strong> 15-25 errors (Current: ${result.issues.length})`;
                resultHTML += `\n‚úÖ <strong>Status:</strong> ${qualityRating}`;
                
                container.innerHTML = resultHTML;
                container.className = `result ${qualityClass}`;
                
            } catch (error) {
                container.innerHTML = `‚ùå Comprehensive analysis failed: ${error.message}`;
                container.className = 'result error';
            }
        };

        // Test custom text
        window.testCustomText = async function() {
            const container = document.getElementById('customResults');
            const textArea = document.getElementById('customText');
            
            container.style.display = 'block';
            container.innerHTML = '<div>‚úçÔ∏è Analyzing custom text...</div>';
            
            try {
                // Ensure service is initialized and ready
                if (!multiEngineService) {
                    console.log('üîß Test: Service not initialized, initializing now...');
                    const initialized = await initializeService();
                    if (!initialized) {
                        throw new Error('Failed to initialize Multi-Engine Grammar Service');
                    }
                }
                
                // Double-check service is ready
                if (!multiEngineService) {
                    throw new Error('Service instance is null after initialization');
                }
                
                const text = textArea.value;
                if (!text.trim()) {
                    throw new Error('Please enter some text to analyze');
                }
                
                const result = await multiEngineService.checkText(text);
                
                let resultHTML = `<strong>‚úçÔ∏è Custom Text Analysis</strong>\n\n`;
                resultHTML += `<div class="stats-grid">`;
                resultHTML += `<div class="stat-card">
                    <div class="stat-value">${text.length}</div>
                    <div class="stat-label">Characters</div>
                </div>`;
                resultHTML += `<div class="stat-card">
                    <div class="stat-value">${text.split(/\s+/).length}</div>
                    <div class="stat-label">Words</div>
                </div>`;
                resultHTML += `<div class="stat-card">
                    <div class="stat-value">${result.issues.length}</div>
                    <div class="stat-label">Issues Found</div>
                </div>`;
                resultHTML += `<div class="stat-card">
                    <div class="stat-value">${result.statistics?.processingTime || 'N/A'}ms</div>
                    <div class="stat-label">Processing Time</div>
                </div>`;
                resultHTML += `</div>\n\n`;
                
                if (result.issues.length > 0) {
                    resultHTML += `üîç <strong>Issues Found:</strong>\n`;
                    result.issues.forEach((issue, index) => {
                        resultHTML += `\n${index + 1}. <strong>${issue.message}</strong>`;
                        resultHTML += `<span class="engine-badge">${issue.engine || 'unknown'}</span>`;
                        resultHTML += `\n   Category: ${issue.category || 'unknown'} | Severity: ${issue.severity || 'medium'}`;
                        if (issue.suggestions && issue.suggestions.length > 0) {
                            resultHTML += `\n   Suggestions: ${issue.suggestions.join(', ')}`;
                        }
                        resultHTML += `\n`;
                    });
                } else {
                    resultHTML += `‚úÖ <strong>No issues found!</strong> The text appears to be well-written.`;
                }
                
                container.innerHTML = resultHTML;
                container.className = result.issues.length > 0 ? 'result info' : 'result success';
                
            } catch (error) {
                container.innerHTML = `‚ùå Custom text analysis failed: ${error.message}`;
                container.className = 'result error';
            }
        };

        // Test deduplication
        window.testDeduplication = async function() {
            const container = document.getElementById('deduplicationResults');
            container.style.display = 'block';
            container.innerHTML = '<div>üîç Testing deduplication...</div>';
            
            try {
                // Ensure service is initialized and ready
                if (!multiEngineService) {
                    console.log('üîß Test: Service not initialized, initializing now...');
                    const initialized = await initializeService();
                    if (!initialized) {
                        throw new Error('Failed to initialize Multi-Engine Grammar Service');
                    }
                }
                
                // Double-check service is ready
                if (!multiEngineService) {
                    throw new Error('Service instance is null after initialization');
                }
                
                // Text with errors that multiple engines should detect
                const duplicateText = "Between you and I, this are a test of the deduplication system. I could of written this better, but there going to be overlapping errors from multiple engines.";
                
                const result = await multiEngineService.checkText(duplicateText);
                
                let resultHTML = `<strong>üîç Deduplication Test Results</strong>\n\n`;
                resultHTML += `<div class="stats-grid">`;
                resultHTML += `<div class="stat-card">
                    <div class="stat-value">${result.issues.length}</div>
                    <div class="stat-label">Final Issues</div>
                </div>`;
                resultHTML += `<div class="stat-card">
                    <div class="stat-value">${result.statistics?.enginesUsed || 'N/A'}</div>
                    <div class="stat-label">Engines Used</div>
                </div>`;
                resultHTML += `<div class="stat-card">
                    <div class="stat-value">${result.statistics?.deduplicationEfficiency || 'N/A'}%</div>
                    <div class="stat-label">Deduplication Efficiency</div>
                </div>`;
                resultHTML += `<div class="stat-card">
                    <div class="stat-value">${result.statistics?.processingTime || 'N/A'}ms</div>
                    <div class="stat-label">Processing Time</div>
                </div>`;
                resultHTML += `</div>\n\n`;
                
                // Show engine contributions
                if (result.statistics?.engineContributions) {
                    resultHTML += `üöÄ <strong>Engine Contributions:</strong>\n`;
                    for (const [engine, issues] of Object.entries(result.statistics.engineContributions)) {
                        const latency = result.statistics.engineLatencies?.[engine] || 'N/A';
                        const performance = typeof latency === 'number' ? 
                            (latency < 100 ? '‚ö°' : latency < 300 ? 'üëç' : '‚ö†Ô∏è') : '';
                        resultHTML += `   ‚Ä¢ ${engine}: ${issues} issues (${latency}ms) ${performance}\n`;
                    }
                }
                
                // Show final issues
                if (result.issues.length > 0) {
                    resultHTML += `\nüîç <strong>Final Issues:</strong>\n`;
                    result.issues.forEach((issue, index) => {
                        resultHTML += `\n${index + 1}. ${issue.message}`;
                        resultHTML += `<span class="engine-badge">${issue.engine || 'unknown'}</span>`;
                    });
                }
                
                container.innerHTML = resultHTML;
                container.className = 'result success';
                
            } catch (error) {
                container.innerHTML = `‚ùå Deduplication test failed: ${error.message}`;
                container.className = 'result error';
            }
        };

        // View comprehensive statistics
        window.viewStatistics = async function() {
            const container = document.getElementById('statisticsResults');
            container.style.display = 'block';
            container.innerHTML = '<div>üìä Loading statistics...</div>';
            
            try {
                // Ensure service is initialized and ready
                if (!multiEngineService) {
                    console.log('üîß Test: Service not initialized, initializing now...');
                    const initialized = await initializeService();
                    if (!initialized) {
                        throw new Error('Failed to initialize Multi-Engine Grammar Service');
                    }
                }
                
                // Double-check service is ready
                if (!multiEngineService) {
                    throw new Error('Service instance is null after initialization');
                }
                
                const stats = multiEngineService.getStatistics();
                
                let resultHTML = `<strong>üìä Multi-Engine Grammar Service Statistics</strong>\n\n`;
                
                // Global stats
                resultHTML += `üåç <strong>Global Statistics:</strong>\n`;
                resultHTML += `   ‚Ä¢ Total Requests: ${stats.global.totalRequests}\n`;
                resultHTML += `   ‚Ä¢ Success Rate: ${Math.round(stats.global.successRate)}%\n`;
                resultHTML += `   ‚Ä¢ Average Processing Time: ${Math.round(stats.global.averageProcessingTime)}ms\n`;
                resultHTML += `   ‚Ä¢ Cache Hit Rate: ${stats.global.cacheHitRate}%\n`;
                resultHTML += `   ‚Ä¢ Active Requests: ${stats.global.activeRequests}\n`;
                resultHTML += `   ‚Ä¢ Queued Requests: ${stats.global.queuedRequests}\n\n`;
                
                // Performance stats
                resultHTML += `‚ö° <strong>Performance Metrics:</strong>\n`;
                resultHTML += `   ‚Ä¢ Target Time: ${stats.performance.targetTime}ms\n`;
                resultHTML += `   ‚Ä¢ Current Average: ${Math.round(stats.performance.currentAverage)}ms\n`;
                resultHTML += `   ‚Ä¢ Efficiency: ${Math.round(stats.performance.efficiency)}%\n\n`;
                
                // Engine details
                resultHTML += `üîß <strong>Engine Performance:</strong>\n`;
                for (const engine of stats.engines) {
                    const status = engine.status === 'loaded' ? '‚úÖ Active' : '‚ùå Disabled';
                    
                    resultHTML += `\n<strong>${engine.name}</strong> ${status}\n`;
                    resultHTML += `   ‚Ä¢ Status: ${engine.status}\n`;
                    resultHTML += `   ‚Ä¢ Health: ${engine.health.overallHealth}\n`;
                    resultHTML += `   ‚Ä¢ Success Count: ${engine.health.successCount}\n`;
                    resultHTML += `   ‚Ä¢ Error Count: ${engine.health.errorCount}\n`;
                    resultHTML += `   ‚Ä¢ Average Processing Time: ${Math.round(engine.health.averageProcessingTime || 0)}ms\n`;
                    if (engine.health.lastUsed) {
                        resultHTML += `   ‚Ä¢ Last Used: ${new Date(engine.health.lastUsed).toLocaleTimeString()}\n`;
                    }
                }
                
                // Health recommendations
                if (stats.health.recommendations.length > 0) {
                    resultHTML += `\nüí° <strong>Recommendations:</strong>\n`;
                    for (const rec of stats.health.recommendations) {
                        resultHTML += `   ‚Ä¢ ${rec}\n`;
                    }
                }
                
                resultHTML += `\n\nüéØ <strong>Performance Goals:</strong>\n`;
                resultHTML += `   ‚Ä¢ Processing Time: <200ms `;
                resultHTML += (stats.performance.currentAverage || 0) < 200 ? '‚úÖ' : '‚ùå';
                resultHTML += `\n   ‚Ä¢ Success Rate: >95% `;
                resultHTML += (stats.global.successRate || 0) > 95 ? '‚úÖ' : '‚ùå';
                resultHTML += `\n   ‚Ä¢ Cache Hit Rate: >20% `;
                resultHTML += (stats.global.cacheHitRate || 0) > 20 ? '‚úÖ' : '‚ùå';
                
                container.innerHTML = resultHTML;
                container.className = 'result info';
                
            } catch (error) {
                container.innerHTML = `‚ùå Statistics loading failed: ${error.message}`;
                container.className = 'result error';
            }
        };

        // Initialize service on page load
        window.addEventListener('load', async () => {
            console.log('üåç Page loaded, initializing Multi-Engine Grammar Service...');
            try {
                const success = await initializeService();
                if (success && multiEngineService) {
                    // Make service globally accessible
                    window.multiEngineService = multiEngineService;
                    console.log('‚úÖ Ready to test! Service is globally accessible');
                } else {
                    console.error('‚ùå Service initialization failed or service is null');
                }
            } catch (error) {
                console.error('‚ùå Initialization failed:', error);
            }
        });
    </script>
</body>
</html> 