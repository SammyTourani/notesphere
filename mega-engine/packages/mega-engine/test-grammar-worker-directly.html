<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct Grammar Worker Test</title>
</head>
<body>
    <h1>Direct Grammar Worker Test</h1>
    <p>Open console to see timing results</p>
    <div id="results"></div>

    <script type="module">
        async function testWorkerDirectly() {
            try {
                console.log('üöÄ Starting direct grammar worker test...');
                
                // Test the worker directly
                const worker = new Worker('./dist/grammar-worker.js', { type: 'module' });
                
                let initTime = 0;
                const initStartTime = performance.now();
                
                // Initialize worker
                worker.postMessage('__init__');
                
                const initPromise = new Promise((resolve, reject) => {
                    worker.onmessage = (e) => {
                        if (e.data === '__ready__') {
                            initTime = performance.now() - initStartTime;
                            console.log(`‚úÖ Worker initialized in ${initTime.toFixed(1)}ms`);
                            resolve();
                        } else if (e.data.error) {
                            console.error('‚ùå Worker initialization failed:', e.data.error);
                            reject(new Error(e.data.error));
                        }
                    };
                });
                
                await initPromise;
                
                // Test grammar checking
                const testSentences = [
                    'The cats is hungry.',
                    'I are going to the store.',
                    'She have many books.',
                    'They was very happy.'
                ];
                
                const results = [];
                
                for (const sentence of testSentences) {
                    const checkStartTime = performance.now();
                    
                    const checkPromise = new Promise((resolve) => {
                        worker.onmessage = (e) => {
                            const checkTime = performance.now() - checkStartTime;
                            const issues = Array.isArray(e.data) ? e.data : [];
                            
                            console.log(`üîç "${sentence}" -> ${issues.length} issues in ${checkTime.toFixed(1)}ms`);
                            if (issues.length > 0) {
                                console.log('üìù Issues:', issues);
                            }
                            
                            results.push({
                                sentence,
                                issues: issues.length,
                                time: checkTime,
                                details: issues
                            });
                            resolve();
                        };
                    });
                    
                    worker.postMessage(sentence);
                    await checkPromise;
                }
                
                // Display results
                const totalIssues = results.reduce((sum, r) => sum + r.issues, 0);
                const avgTime = results.reduce((sum, r) => sum + r.time, 0) / results.length;
                
                const resultHtml = `
                    <h2>‚úÖ SUCCESS!</h2>
                    <p><strong>Initialization:</strong> ${initTime.toFixed(1)}ms</p>
                    <p><strong>Total Issues Found:</strong> ${totalIssues}</p>
                    <p><strong>Average Check Time:</strong> ${avgTime.toFixed(1)}ms</p>
                    <h3>Results:</h3>
                    ${results.map(r => `
                        <div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc;">
                            <p><strong>"${r.sentence}"</strong></p>
                            <p>${r.issues} issues in ${r.time.toFixed(1)}ms</p>
                            ${r.details.length > 0 ? `<pre>${JSON.stringify(r.details[0], null, 2)}</pre>` : ''}
                        </div>
                    `).join('')}
                `;
                
                document.getElementById('results').innerHTML = resultHtml;
                
                if (totalIssues > 0) {
                    console.log('üéâ PROOF OF LIFE: nlprule is working in browser!');
                    console.log(`üìä Summary: ${totalIssues} issues found, avg ${avgTime.toFixed(1)}ms per check`);
                } else {
                    console.log('‚ùå FAIL: No grammar issues detected');
                }
                
                worker.terminate();
                
            } catch (error) {
                console.error('‚ùå Test failed:', error);
                document.getElementById('results').innerHTML = `
                    <h2>‚ùå ERROR</h2>
                    <pre>${error.message}</pre>
                `;
            }
        }
        
        // Start test
        testWorkerDirectly();
    </script>
</body>
</html>
